import networkx as nx
import re

def process_text_message(text: str, graph: nx.Graph = None, expenses=None) -> str:
    """
    expenses ‚Äî —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–∞—Ç–∞.
    –ï—Å–ª–∏ None ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º/–Ω–µ —É–¥–∞–ª—è–µ–º.
    """
    if expenses is None:
        expenses = []  # –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è

    text_lower = text.lower().strip()

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–º–µ—Ä–æ–≤
    if text_lower in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "—Ö–∞–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ", "–ø–æ–º–æ–≥–∏", "—á—Ç–æ —É–º–µ–µ—à—å", ""]:
        return (
            "**–ü—Ä–∏–≤–µ—Ç!** –Ø —á–∞—Ç-–±–æ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤.\n\n"
            "**–ß—Ç–æ —è —É–º–µ—é (–ø—Ä–∏–º–µ—Ä—ã):**\n\n"
            "1. –ú–∞–≥–∞–∑–∏–Ω / —Ç–æ–≤–∞—Ä ‚Üí —Å–≤—è–∑–∏ –≤ –≥—Ä–∞—Ñ–µ:\n"
            "   Starbucks, Magnum, –º–æ–ª–æ–∫–æ, –ø–∏–≤–æ\n\n"
            "2. –ö–∞—Ç–µ–≥–æ—Ä–∏—è:\n"
            "   –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –∞–ª–∫–æ–≥–æ–ª—å\n\n"
            "3. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ (–ª—é–±–∞—è —Ñ—Ä–∞–∑–∞ —Å —Å—É–º–º–æ–π):\n"
            "   –¥–æ–±–∞–≤—å 4500 –ú–∞–≥–Ω—É–º –ø—Ä–æ–¥—É–∫—Ç—ã\n"
            "   –ø–æ—Ç—Ä–∞—Ç–∏–ª 3000 Starbucks –∫–æ—Ñ–µ\n"
            "   –∑–∞–ø–∏—à–∏ 2000 –Ω–∞ –µ–¥—É –≤ Small\n\n"
            "4. –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥:\n"
            "   —É–¥–∞–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π\n"
            "   —É–¥–∞–ª–∏ —Ä–∞—Å—Ö–æ–¥ –æ—Ç 2026-02-20\n\n"
            "5. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é:\n"
            "   –ø–æ–∫–∞–∂–∏ —Ä–∞—Å—Ö–æ–¥—ã\n"
            "   —Å–∫–æ–ª—å–∫–æ –ø–æ—Ç—Ä–∞—Ç–∏–ª\n\n"
            "–ü–∏—à–∏ –∫–∞–∫ –≤ –∂–∏–∑–Ω–∏ ‚Äî —è –ø–æ–π–º—É!"
        )

    if "–ø–æ–∫–∞" in text_lower or "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è" in text_lower:
        return "–ü–æ–∫–∞! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ç—Ä–∞—Ç—ã üòä"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ (–≥–∏–±–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥)
    amount_match = re.search(r'(\d+(?:\.\d+)?)', text_lower)
    if amount_match:
        amount = float(amount_match.group(1))
        text_after = text_lower[amount_match.end():].strip()
        stores = ["magnum", "small", "starbucks", "—è–Ω–¥–µ–∫—Å go"]
        categories = ["–ø—Ä–æ–¥—É–∫—Ç—ã", "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–∞–ª–∫–æ–≥–æ–ª—å", "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è"]

        store = "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
        category = "–î—Ä—É–≥–æ–µ"

        for s in stores:
            if s in text_after:
                store = s.capitalize()
                break
        for c in categories:
            if c in text_after:
                category = c.capitalize()
                break

        if "–ø—Ä–æ–¥—É–∫—Ç" in text_after or "–µ–¥–∞" in text_after:
            category = "–ü—Ä–æ–¥—É–∫—Ç—ã"

        date = "2026-02-26"  # –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ç–µ–∫—É—â—É—é
        new_exp = {"–î–∞—Ç–∞": date, "–ú–∞–≥–∞–∑–∏–Ω": store, "–°—É–º–º–∞": amount, "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": category}
        expenses.append(new_exp)
        return f"–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—Ö–æ–¥: **{amount} ‚Ç∏** –≤ **{store}** ({category}) üéâ"

    # –£–¥–∞–ª–µ–Ω–∏–µ
    if any(word in text_lower for word in ["—É–¥–∞–ª–∏", "—É–¥–∞–ª–∏—Ç—å", "—É–±–µ—Ä–∏", "—Å—Ç–∏—Ä–∞–π"]):
        if expenses:
            expenses.pop()
            return "–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ —É–¥–∞–ª—ë–Ω üóëÔ∏è"
        else:
            return "–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."

    # –ü–æ–∫–∞–∑ –∏—Å—Ç–æ—Ä–∏–∏
    if any(word in text_lower for word in ["–ø–æ–∫–∞–∂–∏", "—Å–∫–æ–ª—å–∫–æ", "–∏—Å—Ç–æ—Ä–∏—è", "—Ä–∞—Å—Ö–æ–¥—ã", "–ø–æ—Ç—Ä–∞—Ç–∏–ª"]):
        return "–ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É ¬´–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤¬ª ‚Äî —Ç–∞–º –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ –∏ —Å—É–º–º–∞."

    # –ì—Ä–∞—Ñ
    if graph is not None:
        if text in graph.nodes:
            neighbors = list(graph.neighbors(text))
            if neighbors:
                return f"–ù–∞—à—ë–ª **{text}** –≤ –≥—Ä–∞—Ñ–µ!\n–°–≤—è–∑–∞–Ω–æ —Å: **{', '.join(neighbors)}**"
            else:
                return f"**{text}** –µ—Å—Ç—å –≤ –±–∞–∑–µ, –Ω–æ —Å–≤—è–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç."

        matches = [node for node in graph.nodes if text_lower in node.lower()]
        if matches:
            return f"–ü–æ—Ö–æ–∂–µ –Ω–∞: **{', '.join(matches)}**\n–£—Ç–æ—á–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞!"

    return "–ù–µ –ø–æ–Ω—è–ª üòÖ –ü–æ–ø—Ä–æ–±—É–π —Å–∫–∞–∑–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è."